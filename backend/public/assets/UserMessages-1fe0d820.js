import{j as e,I as U,u as r,r as l,i as P,w as j,B as A,C as B,o as G,D as H}from"./index-33d448ca.js";import{c}from"./chat.service-ab714e65.js";import{o as E}from"./order.service-8e12d46e.js";function K({order:a,onReserveInfoModal:u}){return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overlay",onClick:u}),e.jsxs("section",{className:"reservation-details-modal reservation-details",children:[e.jsxs("header",{className:"flex center",children:[e.jsx("h1",{children:"Reservation"}),e.jsx("button",{className:"exit-btn",onClick:u})]}),e.jsxs("main",{children:[e.jsx("h2",{className:"title",children:a.stay.name}),e.jsx("div",{className:"img-container",children:e.jsx(U,{imgUrls:a.stay.imgUrls})}),e.jsxs("div",{className:"dates flex space-between",children:[e.jsxs("div",{className:"start flex column",children:[e.jsx("h4",{children:"Starts"}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+a.entryDate).date}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+a.entryDate).time})]}),e.jsxs("div",{className:"end flex column",children:[e.jsx("h4",{children:"Ends"}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+a.exitDate).date}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+a.exitDate).time})]})]}),e.jsxs("div",{className:"confirmation",children:[e.jsx("h4",{children:"Confirmation code"}),e.jsx("p",{children:a._id.slice(18)})]}),e.jsxs("div",{className:"directions",children:[e.jsx("h3",{children:"Getting there"}),e.jsx("h4",{children:"Address"}),e.jsxs("p",{children:[a.stay.location.address,", ",a.stay.location.city,", ",a.stay.location.country]})]}),e.jsxs("div",{className:"payment-info",children:[e.jsx("h3",{children:"Payment info"}),e.jsx("h4",{children:"Total cost"}),e.jsxs("p",{children:["$ ",a.stay.price," USD"]})]})]})]})]})}const J=()=>{const[a,u]=l.useState(P.getLoggedInUser()),[d,N]=l.useState(null),[x,w]=l.useState(null),[n,f]=l.useState(null),[i,T]=l.useState(null),[o,b]=l.useState({type:"all",unread:!1}),[D,C]=l.useState(""),[S,_]=l.useState("chat"),[O,M]=l.useState(!1),p=l.useRef();l.useEffect(()=>{j.on(A,I),j.on(B,y);async function s(){try{const t=await E.getUserOrHostOrdersById(a._id);t&&w(t)}catch(t){console.log(t)}}return s(),()=>j.off(A)},[]),l.useEffect(()=>{async function s(){try{const t=await c.query(o);t&&(N(t),f(t[0]))}catch(t){console.log(t)}}s()},[o]),l.useEffect(()=>{async function s(){try{if(n&&!i){const t=await E.getById(n.orderId);T(t)}else T(null)}catch(t){console.log(t)}}y(),s()},[n]),l.useEffect(()=>{if(n){const s=d.find(t=>t._id===n._id);f(s),y()}},[d]);const I=async s=>{const m=(await await c.query(o)).map(v=>v._id===s._id?s:v);N(v=>m)},h=s=>x.find(m=>m._id===s.orderId);function R(s){b(s==="unread"?{...o,unread:!o.unread}:{...o,type:s.target.value})}function k(s){f(s),_("chat")}function $(){_("list")}function F(s){const t=s.target.value;C(t)}async function L(s){s.preventDefault();const t=c.getEmptyMsg();t.txt=D,n.msgs.push(t),j.emit(H,n),C("");try{await c.update(n)}catch(m){console.log(m)}}function g(){M(!O)}function y(){var s;(s=p.current)==null||s.scrollTo(0,p.current.scrollHeight)}return!x||!x.length?e.jsx(G,{}):e.jsxs("section",{className:"user-messages grid",children:[e.jsxs("section",{className:`chat-list ${S==="list"?"":"hidden"}`,children:[e.jsxs("header",{children:[e.jsx("h1",{children:"Messages"}),e.jsx("div",{className:"action-btns flex",children:e.jsxs("select",{className:"filter",name:"type",onChange:R,children:[e.jsx("option",{value:"all",children:"All"}),e.jsx("option",{value:"host",children:"Hosting"}),e.jsx("option",{value:"buyer",children:"Traveling"})]})})]}),d&&d.length&&n&&x&&e.jsx("ul",{children:d.map(s=>e.jsxs("li",{onClick:()=>k(s),className:`flex ${s._id===n._id?"selected":""}`,children:[e.jsx("img",{src:`${h(s).stay.imgUrls[0]}`}),e.jsxs("div",{className:"msg-info flex column",children:[e.jsxs("div",{className:"flex space-between align-center",children:[e.jsx("h5",{className:"name",children:c.getUserPosition(a._id,s)==="host"?s.buyer.fullname.split(" ")[0]:s.host.fullname.split(" ")[0]}),e.jsx("p",{className:"date",children:r.timestampToFullSlashedDate(s.createdAt)})]}),e.jsx("p",{className:"msg-intro",children:s.msgs&&s.msgs.length?s.msgs[s.msgs.length-1].txt.slice(0,30):""}),e.jsxs("p",{className:"stay-info",children:[r.timestampsToShortDates(h(s).entryDate,h(s).exitDate)," · ",h(s).stay.location.city,", ",h(s).stay.location.country]})]})]},s._id))})]}),e.jsxs("section",{className:`read-chat ${S==="chat"?"":"hidden"}`,children:[e.jsxs("header",{className:"flex align-center",children:[e.jsx("button",{className:"back-list-btn flex center",onClick:$}),n&&i&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:c.getUserPosition(a._id,n)==="host"?n.buyer.imgUrl:n.host.imgUrl}),e.jsx("h5",{className:"name",children:c.getUserPosition(a._id,n)==="host"?n.buyer.fullname.split(" ")[0]:n.host.fullname.split(" ")[0]})]}),i&&e.jsx("button",{className:"reserve-btn-tablet",onClick:g,children:"Show reservation"}),i&&e.jsx("button",{className:"reserve-btn-mobile",onClick:g,children:"Details"})]}),e.jsx("ul",{className:"flex column",ref:p,children:n&&n.msgs.length>0&&e.jsx(e.Fragment,{children:n.msgs.map((s,t)=>e.jsxs("li",{className:`flex column ${a._id===s.by?"user":"other"}`,children:[n.host._id===s.by&&e.jsxs("div",{children:[e.jsx("span",{children:n.host.fullname.split(" ")[0]}),"      ",r.timestampToDateAndTimeObj(s.at).shortDate,"   ",r.timestampToDateAndTimeObj(s.at).time]}),n.host._id!==s.by&&e.jsxs("div",{children:[e.jsx("span",{children:n.buyer.fullname.split(" ")[0]}),"      ",r.timestampToDateAndTimeObj(s.at).shortDate,"   ",r.timestampToDateAndTimeObj(s.at).time]}),e.jsx("pre",{children:s.txt})]},t))})}),e.jsx("footer",{children:e.jsx("form",{onSubmit:L,children:e.jsx("input",{type:"text",placeholder:"Type a message",name:"msg",value:D,onChange:F})})})]}),e.jsxs("section",{className:"reservation-details reservation-details-not-modal",children:[e.jsx("header",{children:e.jsx("h1",{children:"Reservation"})}),i&&e.jsxs("main",{children:[e.jsx("h2",{className:"title",children:i.stay.name}),e.jsx("div",{className:"img-container",children:e.jsx(U,{imgUrls:i.stay.imgUrls})}),e.jsxs("div",{className:"dates flex space-between",children:[e.jsxs("div",{className:"start flex column",children:[e.jsx("h4",{children:"Starts"}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+i.entryDate).date}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+i.entryDate).time})]}),e.jsxs("div",{className:"end flex column",children:[e.jsx("h4",{children:"Ends"}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+i.exitDate).date}),e.jsx("p",{children:r.timestampToDateAndTimeObj(+i.exitDate).time})]})]}),e.jsxs("div",{className:"confirmation",children:[e.jsx("h4",{children:"Confirmation code"}),e.jsx("p",{children:i._id.slice(18)})]}),e.jsxs("div",{className:"directions",children:[e.jsx("h3",{children:"Getting there"}),e.jsx("h4",{children:"Address"}),e.jsxs("p",{children:[i.stay.location.address,", ",i.stay.location.city,", ",i.stay.location.country]})]}),e.jsxs("div",{className:"payment-info",children:[e.jsx("h3",{children:"Payment info"}),e.jsx("h4",{children:"Total cost"}),e.jsxs("p",{children:["$ ",i.stay.price," USD"]})]})]})]}),O&&i&&e.jsx(K,{order:i,onReserveInfoModal:g})]})};export{J as default};
